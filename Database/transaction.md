# トランザクションとデータロック

## DML操作文とは
データ操作言語（DML）文は`INSERT`, `UPDATE`, `DELETE`によって既存の表のデータにアクセスし、操作する。

## DML操作とトランザクション
DML文を含むトランザクションをコミットするまでは、変更は本番DBに反映されない。
トランザクションは、Oracle Databaseが１つの単位として扱うSQL文の順序のこと（１つのDML文のこともある）。
トランザクションをコミットするまではロールバックすることができる。

## DML操作と自動ロック
DMLロック（データ・ロック）の目的は複数のユーザーが同時にアクセスするデータの整合性を保証すること。

### 行ロック
表の１つの行に対するロック。
`INSERT`, `UPDATE`, `DELETE`, `MERGE`, `SELECT ... FOR UPDATE`のいずれかで変更される行ごとに、トランザクションは行ロックを取得する。
行ロックは、トランザクションがコミットされるかロールバックされるまで保持される。  
**行について行ロックを取得したトランザクションは、その行に対応する表についての表ロックも取得する。
この表ロックによって、現行のトランザクション内のデータ変更を上書きするDDL操作の競合が回避される。**

### 表ロック
`INSERT`, `UPDATE`, `DELETE`, `MERGE`, `SELECT ... FOR UPDATE`で表が変更される場合、トランザクションは表ロックを自動的に取得する。
これらのDML操作が表ロックを必要とするのは、トランザクションのために表へのDMLアクセスを確保すること、およびトランザクションと競合する可能性のあるDDL操作を防止するという２つの目的のため。
表ロックは、`LOCK TABLE`文を使用して明示的に取得できる。

## 問合せとロック
- 問合せはデータ・ロックを行わない。そのため、特定の行に対して問合せが実行される場合も含め、問合せが実行されている表を、ほかのトランザクションが問い合わせて更新できる。
- 問合せでは、データ・ロックが解除されるまで待機する必要はない。そのため、問合せはいつでも実行できる。

## `INSERT`, `UPDATE`, `DELETE`, `SELECT ... FOR UPDATE`の特性
- DML文を含むトランザクションはその文の変更対象の行に対して行排他ロックを取得する。
そのため、行をロックしているトランザクションがコミットまたはロールバックされるまで、ほかのトランザクションはロックされている行を更新したり削除することはできない。
- 行ロックに加え、データを変更するDML文を含むトランザクションは、変更対象の行を含む表に対して副排他表ロック以上のロックを取得する。
- DML文を含むトランザクションは、副問合せや暗黙的な問合せによって選択される行に対して行ロックを取得する必要はない。
```
UPDATE T
   SET X = (SELECT y             # 副問合せ　　　
              FROM T2            # 副問合せ
             WHERE T2.Z = T.Z)   # 副問合せ
 WHERE A > 5;                    # 暗黙的な問合せ
```
- トランザクション内の問合せは、同じトランザクション内の前のDML文で行われた変更を参照できるが、他のトランザクションのコミットされていない変更は参照できない。


## 参考
- [Oracle® Database SQL言語リファレンス 11gリリース2 (11.2)　DML操作での自動ロック](https://docs.oracle.com/cd/E16338_01/server.112/b56299/ap_locks001.htm)
